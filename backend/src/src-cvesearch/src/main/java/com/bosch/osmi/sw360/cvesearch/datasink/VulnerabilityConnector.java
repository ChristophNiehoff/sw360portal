package com.bosch.osmi.sw360.cvesearch.datasink;

import com.siemens.sw360.datahandler.common.DatabaseSettings;
import com.siemens.sw360.datahandler.couchdb.DatabaseConnector;
import com.siemens.sw360.datahandler.db.ComponentRepository;
import com.siemens.sw360.datahandler.db.ReleaseRepository;
import com.siemens.sw360.datahandler.db.VendorRepository;
import com.siemens.sw360.datahandler.thrift.RequestStatus;
import com.siemens.sw360.datahandler.thrift.components.Release;
import com.siemens.sw360.datahandler.thrift.vulnerabilities.Vulnerability;
import com.siemens.sw360.vulnerabilities.db.VulnerabilityDatabaseHandler;

import java.io.IOException;
import java.util.List;

/**
 * Created by heydenrb on 19.05.16.
 */
public class VulnerabilityConnector {

    VulnerabilityDatabaseHandler vulnerabilityDatabaseHandler;
    ComponentRepository componentRepository;
    ReleaseRepository releaseRepository;
    VendorRepository vendorRepository;

    public VulnerabilityConnector() throws IOException{
        vulnerabilityDatabaseHandler = new VulnerabilityDatabaseHandler(DatabaseSettings.COUCH_DB_URL, DatabaseSettings.COUCH_DB_VM);

        DatabaseConnector db = new DatabaseConnector(DatabaseSettings.COUCH_DB_URL, DatabaseSettings.COUCH_DB_DATABASE);
        vendorRepository = new VendorRepository(db);
        releaseRepository = new ReleaseRepository(db, vendorRepository);
        componentRepository = new ComponentRepository(db, releaseRepository, vendorRepository);
    }

    public Release getRelease(String releaseId){
        return releaseRepository.get(releaseId);
    }

    public RequestStatus addOrUpdateVulnerability(Vulnerability vulnerability){
        return vulnerabilityDatabaseHandler.add(vulnerability);
    }

    public RequestStatus addOrUpdateVulnerabilities(List<Vulnerability> vulnerabilities){
        RequestStatus totalStatus = RequestStatus.SUCCESS;

        for (Vulnerability vulnerability : vulnerabilities){
            RequestStatus singleOperationStatus = addOrUpdateVulnerability(vulnerability);
            if (RequestStatus.FAILURE.equals(singleOperationStatus)){
                totalStatus = RequestStatus.FAILURE;
            }
        }

        return  totalStatus;
    }
}
